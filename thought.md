# 记录开发遇到的问题/难点

## 用户反馈红石音乐提示制作成功但是没有音轨

### 问题
引导用户打开控制台查看报错，显示*ReferrenceError: structuredClone is not defined*  
这个函数在**/utils/MIDI.js**中被引用，用来深复制一个对象，开发时在MDN上看到该函数广泛可用，于是便没有考虑兼容性问题。提示用户切换到最新版Edge浏览器则正常运行，而使用四五年未更新的chrome浏览器则出问题。查看MDN兼容性日志，大多数浏览器在2022年初实现了该函数，所以老版本出现问题也就不足为奇。

### 解决方案
除了引导用户使用新版浏览器，更重要的是做好兼容性预案：  
* 在项目运行前检查window.structedClone是否存在，如不存在则需要手动实现该方法
* 使用成熟可靠的方案替代structedClone，比如lodash库，或者自己实现一个递归深复制

### 启示
* 虽然MDN上写了广泛兼容，但是对于时间相对较近（四五年之内）的特性，使用时应当保守
* 项目急需报错自动上传机制
	原因：
	- 不是所有用户都会主动反馈问题；
	- 报错和环境、时机、用户操作方式等随机因素相关，开发时不一定能预想到；
	- 通过报错信息，往往能第一时间找到根源。

## 用户反馈不同时间制作的像素画不一样

### 问题
2025/2/17网站大版本更新后，图像算法做了改进，因此在这前后制作的像素画会有差异，给部分用户备料带来困惑。

### 解决方案
可以为用户开放一个“旧版页面”实现兼容，但是这次版本更新颠覆了许多，后端服务器也做了很大的变动，因此我没有精力去做这么一个功能。  
最终我在本地运行旧的项目，为用户单独制作了旧版像素画。

### 启示
一定要多站在用户的角度考虑，不能只从技术角度一味追求新意和变革，要考虑到前后兼容和用户适应。

## 如何为耗时/异步任务设计一个等待框，并且支持任务终止

### 思路
封装一个模态框组件，提供一个show函数用于接收和启动任务并显示等待框。  
* 耗时任务（如图像算法、3D体素算法等）需要写在单独的js文件里，通过Web Worker实现不阻塞UI，需传入实现Worker的js文件路径名。
* 异步任务均通过Promise实现，需传入一个Promise对象。

任务取消：取消按钮按下后Promise需要reject、Web Worker任务需立即终止
* Promise任务最终是要获取返回值或者reject，创建一个新的Promise并保存其reject到全局变量，通过Promise.race并行原Promise和新Promise，按钮按下后对新Promise进行reject
* Web Worker里执行的是循环操作（遍历二维、三维数组，对每个元素执行操作），取消按钮按下后调用Worker.terminate()终止任务

### 问题
直接调用Worker.terminate()终止发现任务并不会立即终止，仍然会执行完所有循环，这并不是我想要的（因为终止之后我不希望任务还在浪费我的CPU和内存资源）。改为通过postmessage传递控制信号，一样的徒劳无功。**因为循环阻塞了Web Worker的事件循环**。

### 解决方案
Web Worker是单线程的，但是同样基于事件循环，所以我们可以将任务拆分，把小的任务块放入不同的事件循环里执行，所有小块执行完毕后汇总即可。  
> js单个事件循环先执行宏任务，再从微任务队列中取出所有微任务执行。

使用setTimeout(callback, 0)就可以将callback任务放入下次事件循环宏任务中，借助递归就可以遍历完所有任务。

### 改进方向
目前Promise只是实现了主动reject，而不是真正取消原任务的执行，对于网络请求这种异步任务，fetch可以通过AbortSignal实现通信终止，所以可以进一步对任务的类型进行细分和处理。